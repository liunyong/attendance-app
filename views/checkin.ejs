<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Check-In</title>
    <style>
        :root {
            --main-color: #2d8cf0;
            --accent: #f8f8f8;
            --border: #e0e0e0;
            --radius: 10px;
        }
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: var(--accent);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin-top: 32px;
            color: var(--main-color);
            font-size: 2.2rem;
            letter-spacing: 1px;
        }
        #currentDateTime {
            font-size: 1.8rem;
            color: #666;
            margin-bottom: 18px;
            display: block;
        }
        form {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 24px 20px 18px 20px;
            margin: 0 auto 18px auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-width: 260px;
            max-width: 340px;
        }
        label {
            font-size: 1rem;
            color: #333;
            margin-bottom: 6px;
        }
        select, input[type="text"], input[type="password"] {
            padding: 9px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 14px;
            background: #fafbfc;
        }
        button {
            background: var(--main-color);
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 11px 11px;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }
        button:hover, button:focus {
            background: #1766b3;
        }
        a, .modal button[type="button"] {
            color: var(--main-color);
            background: none;
            border: none;
            font-size: 1rem;
            margin: 0 8px;
            cursor: pointer;
            text-decoration: underline;
        }
        .action-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }
        /* Modal styles */
        .modal { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); justify-content:center; align-items:center; z-index:10; }
        .modal-content { background:#fff; padding:28px 22px 18px 22px; border-radius:var(--radius); min-width:260px; box-shadow:0 4px 24px rgba(0,0,0,0.08);}
        .modal-content h2 { margin-top:0; color:var(--main-color); font-size:1.3rem; }
        .modal-content form { box-shadow:none; border:none; padding:0; }
        .modal-content label { margin-bottom:2px; }
        .modal-content input[type="text"], .modal-content input[type="password"] {
            margin-bottom:10px;
        }
        .modal-content button[type="submit"] {
            margin-top:8px;
        }
        .modal-content #regMsg, .modal-content #adminLoginMsg {
            color:#d32f2f;
            font-size:0.97rem;
            margin-top:6px;
            min-height:22px;
        }
        @media (max-width: 600px) {
            h1 { font-size:1.3rem; }
            form, .modal-content { min-width: 90vw; max-width: 98vw; }
        }
    </style>
</head>
<body>
    <h1>Check-In</h1>
    <span id="currentDateTime"></span>
    <form id="checkinForm" action="/checkin" method="post" autocomplete="off">
        <label for="teacher">Select Teacher</label>
        <select name="teacher" id="teacher" required>
            <% teachers.forEach(function(teacher){ %>
                <option value="<%= teacher.name %>"><%= teacher.name %></option>
            <% }); %>
        </select>
        <label for="password">Password</label>
        <input type="password" name="password" id="password" required autocomplete="off">
        <button type="submit">Check In</button>
    </form>
    <div class="action-row">
        <button type="button" onclick="document.getElementById('regModal').style.display='flex'">  Register  </button>
        <a href="#" onclick="document.getElementById('adminLoginModal').style.display='flex'">View Log</a>
    </div>

    <!-- Teacher Registration Modal -->
    <div id="regModal" class="modal">
      <div class="modal-content">
        <h2>Register</h2>
        <form id="registerForm" autocomplete="off">
          <label>Name <input type="text" name="name" required></label>
          <label><input type="checkbox" name="excused"> Excused (07:40)</label>
          <label>Password <input type="password" name="password" required></label>
          <button type="submit">Register</button>
          <button type="button" onclick="document.getElementById('regModal').style.display='none'">Cancel</button>
        </form>
        <div id="regMsg"></div>
      </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
      <div class="modal-content">
        <h2>Admin Login</h2>
        <form id="adminLoginForm" autocomplete="off">
          <label>ID <input type="text" name="id" required></label>
          <label>Password <input type="password" name="password" required></label>
          <button type="submit">Login</button>
          <button type="button" onclick="document.getElementById('adminLoginModal').style.display='none'">Cancel</button>
        </form>
        <div id="adminLoginMsg"></div>
      </div>
    </div>

    <script>
        // Update current date and time
        function updateTime() {
            const dateOptions = { timeZone: "Asia/Shanghai", year: 'numeric', month: '2-digit', day: '2-digit' };
            const timeOptions = { timeZone: "Asia/Shanghai", hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: false };
            const weekdayOptions = { timeZone: "Asia/Shanghai", weekday: 'short' };
            const nowDate = new Date();
            const dateStr = nowDate.toLocaleDateString("sv-SE", dateOptions);
            const timeStr = nowDate.toLocaleTimeString("sv-SE", timeOptions);
            const weekdayStr = nowDate.toLocaleDateString("en-US", weekdayOptions);
            const now = `${dateStr} (${weekdayStr}) ${timeStr}`;
            document.getElementById("currentDateTime").innerText = now;
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Teacher check-in form
        document.getElementById("checkinForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new URLSearchParams(new FormData(form));
            fetch(form.action, {
                method: "POST",
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert(data.message);
                    // Remove selected teacher from dropdown
                    const select = document.getElementById("teacher");
                    const selectedVal = select.value;
                    const optionToRemove = select.querySelector('option[value="'+selectedVal+'"]');
                    if(optionToRemove) {
                        optionToRemove.remove();
                    }
                    if(select.options.length === 0){
                        form.querySelector("button").disabled = true;
                    }
                    form.password.value = "";
                } else {
                    alert("Error: " + data.message);
                    form.password.value = "";
                }
            })
            .catch(() => alert("An error occurred."));
        });

        // Teacher registration
        document.getElementById('registerForm').onsubmit = async function(e) {
          e.preventDefault();
          const form = e.target;
          const data = {
            name: form.name.value,
            excused: form.excused.checked,
            password: form.password.value
          };
          const res = await fetch('/register-teacher', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await res.json();
          document.getElementById('regMsg').innerText = result.message;
          console.log(result.success);
          console.log("Message logged");
          if(result.success) {
            location.reload();
          }
        };

        // Admin login
        document.getElementById('adminLoginForm').onsubmit = async function(e) {
          e.preventDefault();
          const form = e.target;
          const data = {
            id: form.id.value,
            password: form.password.value
          };
          const res = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await res.text();
          if(result.includes('<!DOCTYPE html>')) {
            window.location.href = "/log";
          } else {
            document.getElementById('adminLoginMsg').innerText = "Login failed: Please check your ID or password.";
          }
        };

        // Modal close only when clicking outside the modal-content
        function setupModalClose(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.addEventListener('mousedown', function(e) {
                // Only close if the click is directly on the modal background, not on modal-content or its children
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        setupModalClose('regModal');
        setupModalClose('adminLoginModal');
    </script>
</body>
</html>